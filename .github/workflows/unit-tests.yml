name: Tests

on:
  pull_request:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions: {}

jobs:
  tests:
    name: Tests
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        name: [backend, frontend-merge, frontend-pr]
        include:
          - name: backend
            dir: .
            triggers: ('backend/')
            expected_triggered: false
          - name: frontend-merge
            dir: .
            triggers: ('.')
            expected_triggered: true
          - name: frontend-pr
            dir: .
            expected_triggered: true
    steps:
      - uses: actions/checkout@v5
      - id: action
        uses: ./
        with:
          commands: |
            echo "Running tests in ${{ matrix.dir }}"
            mvn -B --version
          dir: ${{ matrix.dir }}
          java-distribution: temurin
          java-version: "17"
          repository: bcgov/nr-forest-client          
          sonar_args: >
            -Dsonar.exclusions=**/coverage/**
            -Dsonar.organization=bcgov-nr
            -Dsonar.projectKey=action-test-and-analyse-java_${{ matrix.dir }}
          sonar_token: ${{ matrix.name == 'backend' && secrets.SONAR_TOKEN_BACKEND || secrets.SONAR_TOKEN_FRONTEND }}
          triggers: ${{ matrix.triggers }}

      - name: Verify trigger behavior
        run: |
          echo "üîç Verifying trigger behavior for ${{ matrix.name }}"
          echo "Expected: ${{ matrix.expected_triggered }}"
          echo "Actual: ${{ steps.action.outputs.triggered }}"

          case "${{ matrix.name }}" in
            "backend")
              if [ "${{ steps.action.outputs.triggered }}" != "false" ]; then
                echo "‚ùå Backend job should NOT have been triggered (no backend/ changes)"
                exit 1
              else
                echo "‚úÖ Backend job correctly NOT triggered"
              fi
              ;;
            "frontend-merge")
              if [ "${{ steps.action.outputs.triggered }}" != "true" ]; then
                echo "‚ùå Frontend-merge job should have been triggered (triggers: '.')"
                exit 1
              else
                echo "‚úÖ Frontend-merge job correctly triggered"
              fi
              ;;
            "frontend-pr")
              if [ "${{ steps.action.outputs.triggered }}" != "true" ]; then
                echo "‚ùå Frontend-pr job should have been triggered (no triggers = always run)"
                exit 1
              else
                echo "‚úÖ Frontend-pr job correctly triggered"
              fi
              ;;
          esac

          echo "üéâ ${{ matrix.name }} trigger behavior verified correctly!"
